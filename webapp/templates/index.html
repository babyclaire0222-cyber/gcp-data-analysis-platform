<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Data Analysis Platform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --ok:#4CAF50; --ok2:#45a049; --err:#f8d7da; --errtx:#721c24; --okbg:#d4edda; --oktx:#155724; }
    body { font-family: Arial, sans-serif; margin: 40px; }
    .container { max-width: 720px; margin: auto; }
    h1 { color: #333; margin-bottom: 10px; }
    form { margin: 16px 0 24px; }
    input[type="file"], input[type="text"] { padding: 8px; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
    button { padding: 10px 20px; background-color: var(--ok); color: #fff; border: none; cursor: pointer; border-radius: 4px; }
    button:hover { background-color: var(--ok2); }
    .message { margin-top: 16px; padding: 10px; border-radius: 4px; display:none; }
    .success { background-color: var(--okbg); color: var(--oktx); }
    .error { background-color: var(--err); color: var(--errtx); }
    #download-link { display: none; margin-top: 12px; }
    .dim { opacity: 0.6; pointer-events: none; }
    .badge { display:inline-block; background:#eef; color:#335; padding:6px 10px; border-radius: 16px; font-size: 12px; }
    .muted { color:#666; font-size: 14px; }
    hr { border:0; border-top:1px solid #eee; margin: 24px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Data Analysis Platform</h1>
    <p class="muted">Access is protected by <strong>Google Cloud IAP</strong>. If you’re not signed in, you’ll be redirected by IAP automatically.</p>

    <!-- Signed-in user (from IAP via /whoami) -->
    <p id="user-info" class="badge" style="display:none;"></p>
    <div id="auth-message" class="message error" style="display:none;"></div>

    <!-- Upload Section (enabled once /whoami returns 200) -->
    <div id="upload-section" class="dim" style="display:none;">
      <form id="uploadForm" method="POST" enctype="multipart/form-data">
        <input type="file" name="file" required />
        <button type="submit">Upload & Analyze</button>
      </form>

      <div id="message" class="message" style="display:none;"></div>

      <!-- Auto download link for latest analysis CSV -->
      <div id="download-link">
        <a id="download-url" href="#" download>⬇ Download Analysis Results (CSV)</a>
      </div>
    </div>

    <hr />

    <!-- Manual BigQuery Download -->
    <h2>Manual BigQuery Download</h2>
    <form id="downloadForm">
      <input type="text" name="table" placeholder="Enter table name" required />
      <button type="submit">Download Latest Analysis</button>
    </form>
  </div>

  <script>
    // Helper to show messages
    const showMsg = (el, text, ok=false) => {
      el.textContent = text;
      el.className = "message " + (ok ? "success" : "error");
      el.style.display = "block";
    };

    // On load: check whoami (IAP header should make this 200)
    (async function boot() {
      const userInfo = document.getElementById("user-info");
      const authMsg  = document.getElementById("auth-message");
      const upload   = document.getElementById("upload-section");

      try {
        const resp = await fetch("/whoami", { credentials: "include" });
        if (resp.status === 200) {
          const data = await resp.json();
          const email = (data && data.email) || "(unknown)";
          userInfo.textContent = `Signed in as: ${email}`;
          userInfo.style.display = "inline-block";

          upload.style.display = "block";
          upload.classList.remove("dim");
          authMsg.style.display = "none";
        } else if (resp.status === 401) {
          // IAP should have intercepted already; if we ever get here, hint user to re-auth
          showMsg(authMsg, "Not authorized. Please refresh to sign in via Google.", false);
          upload.style.display = "none";
        } else {
          showMsg(authMsg, "Unexpected response from server. Try refreshing the page.", false);
        }
      } catch (e) {
        showMsg(authMsg, "Unable to reach server. Check your connection or try again.", false);
      }
    })();

    // File upload
    document.getElementById("uploadForm").onsubmit = async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const messageDiv = document.getElementById("message");
      const downloadDiv = document.getElementById("download-link");
      const downloadUrl = document.getElementById("download-url");

      messageDiv.style.display = "none";
      downloadDiv.style.display = "none";
      showMsg(messageDiv, "⏳ Uploading file & processing in BigQuery...", true);

      try {
        const response = await fetch("/", { method: "POST", body: formData, credentials: "include" });
        const result = await response.json().catch(() => ({}));

        if (response.status === 401) {
          messageDiv.className = "message error";
          messageDiv.textContent = "❌ Unauthorized. Please refresh to sign in via Google.";
          return;
        }

        if (result && result.success) {
          showMsg(messageDiv, "✅ " + (result.message || "Completed"), true);
          if (result.table) {
            downloadUrl.href = `/download_bq?table=${encodeURIComponent(result.table)}`;
            downloadDiv.style.display = "block";
          }
        } else {
          messageDiv.className = "message error";
          messageDiv.textContent = "❌ " + (result.error || "Unknown error");
        }
      } catch (err) {
        messageDiv.className = "message error";
        messageDiv.textContent = "❌ Upload failed: " + err.message;
      }
    };

    // Manual download
    document.getElementById("downloadForm").onsubmit = function(e) {
      e.preventDefault();
      const table = this.table.value.trim();
      if (table) {
        // No tokens needed—request already passed IAP
        window.location.href = `/download_bq?table=${encodeURIComponent(table)}`;
      }
    };
  </script>
</body>
</html>

